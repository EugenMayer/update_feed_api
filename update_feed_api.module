<?php
// $Id$

// Copyright (c) 2010 KontextWork
// Author: Eugen Mayer

/**
 * Implementation of hook_autoload_info().
 */

function update_feed_api_menu() {
  return array(
    'admin/build/refresh_update_feeds' => array(
       'title' => 'Refresh Update Feeds',
       'page callback' => 'drupal_get_form',
       'page arguments' => array('update_feed_api_refresh_form'),
       'access arguments' => array('administer site configuration'),
       'file' => 'update_feed_api.admin.inc'
    ),
    'admin/settings/update_feed_api_settings' => array (
      'type' => MENU_NORMAL_ITEM,
      'title' => 'Update Feed API configuration',
      'description' => 'Configure update feed api',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('update_feed_api_admin_settings'),
      'access arguments' => array('administer site configuration'),
      'file' => 'update_feed_api.admin.inc'
     )
  );
}

function _update_feed_api_get_feeds() {
  // Must have the format: Descriptive=css_style,Descriptive2=css_style2..
  $settings = variable_get('update_feed_api_feeds', '');
  $feeds = array();
  if ($settings != '') {
    $feeds_lines = array();
    $feeds_lines = preg_split("/((\r(?!\n))|((?<!\r)\n)|(\r\n))/", $settings);
    foreach ($feeds_lines as $feed) {
      $feed = explode('|',$feed);
      $feed = array(
        'host' => $feed[0],
        'server_key' => $feed[1],
        'class' => $feed[2],
      );
      // validate
      if(!class_exists($feed['class']) || array_search('IUpdate_feed', class_implements($feed['class'])) === FALSE) {
        drupal_set_message('Cant fetch feed '.$feed['server_key']." as the class ({$feed['class']}) is missing, not loadable or does not implement the IUpdate_feed interface");
        continue;
      }
      //else
      $feeds[] = $feed;
    }
  }
  return $feeds;
}

function _update_feed_api_clear_tables() {
  db_query('TRUNCATE TABLE {update_feed_api_projects}');
  db_query('TRUNCATE TABLE {update_feed_api_releases}');
}

function update_feed_api_autoload_info() {
  $path = drupal_get_path('module','update_feed_api').'/includes/';
  return array(
    'FeedEntryContainer' => array(
      'file' => 'feedentrycontainer.class.inc',
      'file path' => $path,
    ),
    'Project' => array(
      'file' => 'project.class.inc',
      'file path' => $path,
    ),
    'Release' => array(
      'file' => 'release.class.inc',
      'file path' => $path,
    ),
    'Project_factory' => array(
      'file' => 'factories.class.inc',
      'file path' => $path,
    ),
    'Release_factory' => array(
      'file' => 'factories.class.inc',
      'file path' => $path,
    ),
    'SmartDOMDocument' => array(
      'file' => 'smartdomdocument.class.inc',
      'file path' => $path,
    ),
    'Update_feed' => array(
      'file' => 'update_feed.class.inc',
      'file path' => $path,
    ),
  );
}

/**
 * Implements hook_views_api().
 */
function update_feed_api_views_api() {
  return array(
    'api' => 2.0,
  );
}
